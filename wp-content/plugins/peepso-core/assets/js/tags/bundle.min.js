!function n(r,o,p){function d(e,t){if(!o[e]){if(!r[e]){var s="function"==typeof require&&require;if(!t&&s)return s(e,!0);if(h)return h(e,!0);var a=new Error("Cannot find module '"+e+"'");throw a.code="MODULE_NOT_FOUND",a}var i=o[e]={exports:{}};r[e][0].call(i.exports,function(t){return d(r[e][1][t]||t)},i,i.exports,n,r,o,p)}return o[e].exports}for(var h="function"==typeof require&&require,t=0;t<p.length;t++)d(p[t]);return d}({1:[function(t,e,s){"use strict";t("./tagging"),t("./peepsotags")},{"./peepsotags":2,"./tagging":3}],2:[function(t,e,s){"use strict";var a,i;a=jQuery||$,i=peepso,function(o,p,e){function s(){}s.prototype.init=function(){var i=this;this.taggable_inputs=ps_observer.apply_filters("peepsotags_taggable_inputs",["#postbox-main textarea.ps-postbox-textarea"]),this.init_tags(this.taggable_inputs.join(",")),this.init_tags_comments(),o(document).on("peepso_tags_init_comments ps_activitystream_append ps_activitystream_loaded peepso_repost_added",function(){i.init_tags_comments()}),o(document).on("ps_comment_save",function(){i.init_tags_comments()}),ps_observer.add_filter("postbox_req_edit",function(e,t){return t.ps_tagging("val",function(t){e.post=t}),e},10,2),ps_observer.add_filter("comment_req",function(e,t){return o(t).ps_tagging("val",function(t){e.content=t,e.post=t}),e},10,2),ps_observer.add_filter("comment_cancel",function(t){o(t).ps_tagging("reset")},10,2),ps_observer.add_filter("modalcomments.afterchange",function(t){t&&t.$attachment&&t.$attachment.find(".ps-comment-reply textarea").ps_tagging()},10,2),ps_observer.add_filter("caption_req",function(e,t){return o(t).ps_tagging("val",function(t){e.description=t}),e},10,2),ps_observer.add_filter("comment.reply",function(t,e){if(e.id!=peepsodata.currentuserid&&e.id&&e.name){var s=_.template(peepsotagsdata.template);t.val(s({id:e.id,title:e.name})+" "),t.removeData("ps_tagging"),i.init_tags_comments(t)}},10,2),o("#peepso-wrap").on("comment.saved",function(t,e,s,a){o(s).ps_tagging("reset")}),o("#peepso-wrap").on("post_edit.shown",function(t,e,s){var a=s.find("textarea");i.init_tags(a)}),ps_observer.add_action("comment_edit",o.proxy(function(t,e){var s=o(e).find("textarea");this.init_tags(s)},this),10,2),ps_observer.add_action("postbox_update",o.proxy(function(t){this.init_tags(t.$text)},this),10,1),ps_observer.add_filter("postbox_data",function(e,t){return t.$text.ps_tagging("val",function(t){e.content=t}),e},10,2)},s.prototype.init_tags=function(t){var a,i=!1,n=!1;o(t).one("focus.get_taggable",function(){var t=ps_observer.apply_filters("tags_get_taggable_params",{});i=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(a=t.data.users),"function"==typeof n&&n(a||[]),i=!1})}),o(t).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){if(a)e(a,"cache");else if(i)n=e;else{var s=ps_observer.apply_filters("tags_get_taggable_params",{});p.postJson("tagsajax.get_taggable",s,function(t){t.success&&(a=t.data.users),e(a||[])})}}})},s.prototype.init_tags_comments=function(t){t||(t='[data-type="stream-newcomment"] textarea[name="comment"]'),o(t).each(function(t,a){var i,n=!1,r=!1;o(a).one("focus.get_taggable",function(){var t=ps_observer.apply_filters("tags_get_taggable_params",{act_id:o(a).data("act-id")});n=!0,p.postJson("tagsajax.get_taggable",t,function(t){t.success&&(i=t.data.users),"function"==typeof r&&r(i||[]),n=!1})}),o(a).ps_tagging({syntax:_.template(peepsotagsdata.template),parser:new RegExp(peepsotagsdata.parser,"gi"),parser_groups:{id:1,title:2},fetcher:function(t,e){if(i)e(i,"cache");else if(n)r=e;else{var s=ps_observer.apply_filters("tags_get_taggable_params",{act_id:o(a).data("act-id")});p.postJson("tagsajax.get_taggable",s,function(t){t.success&&(i=t.data.users),e(i||[])})}}}),ps_observer.add_filter("comment_can_submit",function(t){var e=o(t.el).data("ps_tagging");return e.dropdown_is_visible&&(t.can_submit=!1),t},20,1),o(a).ps_autosize()})},s.prototype.apply_line_breaks=function(t){var o=t;o.wrap,o.setAttribute("wrap","off");var e=o.value;o.value="";var p=o.scrollWidth;function d(t,e,s){var a;if(void 0===e)e=0,s=-1,a=64;else if(-1===s)a=2*e;else{if(s-e<=1)return Math.max(2,s);a=e+(s-e)/2}var i,n=t.substr(0,a),r=(i=n,o.value=i,o.scrollWidth>p);if(r)s=a;else{if(a>=t.length)return null;e=a}return d(t,e,s)}for(var s,a=0,i="";a<e.length;){var n=d(e.substr(a));if(null===n){i+=e.substr(a);break}var r=n-1;for(s=r-1;0<=s;s--){var h=e.charAt(a+s);if(" "===h||"-"===h||"+"===h){r=s+1;break}}i+=e.substr(a,r)+"\n",a+=r}o.value=i,o.setAttribute("wrap","")},o(function(){var t=new s;t.init(),o(".ps-postbox-tab.interactions .ps-button-cancel").on("click",function(){o("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")}),o("#postbox-main .postbox-submit").on("click",function(){o("#postbox-main textarea.ps-postbox-textarea").ps_tagging("reset")})}),e.addFilter("peepso_postbox_addons",function(t){return t.push({init:o.noop,set_postbox:function(t){"postbox-main"===t.attr("id")&&e.addFilter("postbox_req_"+t.guid,function(e){return o("#postbox-main textarea.ps-postbox-textarea").ps_tagging("val",function(t){e.content=t}),e},10,1)}}),t},10,1)}(a,i,i.observer)},{}],3:[function(t,e,s){"use strict";var i,a,n,r,o="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};i=jQuery||$,a=_,n=peepso,r=function(d,a,t){var s=13,i=27,n=38,r=40,o=/@\[\[(\d+):user:([^\]]+)\]\]/g,p=/@\[\[(\d+):user:([^\]]+)\]\]/,e=".ps-tagging",h=".ps-tagging-wrapper",_=".ps-tagging-beautifier",g=".ps-tagging-hidden",l=".ps-tagging-dropdown",u=".ps-tagging-dropdown-item",c=".active",f=".ps-tagging-loading";function v(t,e){return this.textarea=t,this.options=e||{},this.init(),this}return v.prototype.init=function(){this.dom_prepare(),this.textarea.value&&(this.parse_tags(),this.textarea_on_input()),this.$textarea.off(e).on("focus"+e,d.proxy(this.textarea_on_keydown,this)).on("click"+e,d.proxy(this.textarea_on_keydown,this)).on("keydown"+e,d.proxy(this.textarea_on_keydown,this)).on("keyup"+e,d.proxy(this.textarea_on_keyup,this)).on("input"+e,d.proxy(this.textarea_on_input,this)).on("blur"+e,d.proxy(this.textarea_on_blur,this)),this.$dropdown.off(e).on("mouseenter"+e,u,d.proxy(this.dropdown_on_mouseenter,this)).on("mousedown"+e,u,d.proxy(this.dropdown_on_mousedown,this)).on("mouseup"+e,u,d.proxy(this.dropdown_on_mouseup,this))},v.prototype.dom_prepare=function(){this.$textarea=d(this.textarea),this.$textarea.addClass(".ps-tagging-textarea".substr(1)),this.$wrapper=this.$textarea.parent(h),this.$wrapper.length||(this.$textarea.wrap('<div class="'+h.substr(1)+'"></div>'),this.$wrapper=this.$textarea.parent()),this.$beautifier=this.$wrapper.children(_),this.$beautifier.length||(this.$beautifier=d('<div class="'+_.substr(1)+'"></div>'),this.$beautifier.prependTo(this.$wrapper)),this.$hidden=this.$wrapper.children(g),this.$hidden.length||(this.$hidden=d('<input type="hidden" class="'+g.substr(1)+'">'),this.$hidden.appendTo(this.$wrapper)),this.$dropdown=this.$wrapper.children(l),this.$dropdown.length||(this.$dropdown=d('<div class="'+l.substr(1)+'"></div>'),this.$dropdown.appendTo(this.$wrapper))},v.prototype.parse_tags=function(){var t,e,s,a,i,n=this.textarea.value;if(this.options.parser&&(t=this.options.parser_groups||{},n=n.replace(this.options.parser,function(){return"@[["+(arguments[t.id]||"")+":user:"+(arguments[t.title]||"")+"]]"})),e=n.match(o),this.textarea.value=n.replace(o,"$2"),this.tags_added=[],e&&e.length)for(i=0;i<e.length;i++)s=e[i].match(p),a=n.indexOf(e[i]),n=n.replace(e[i],s[2]),this.tags_added.push({id:s[1],name:s[2],start:a,length:s[2].length})},v.prototype.reset=function(){var t=this.textarea.value="",e=this.tags_added=[],s=this;setTimeout(function(){s.$textarea.trigger("keyup"),s.$textarea.trigger("input")}),this.hidden_update(t,e),this.dropdown_hide()},v.prototype.val=function(){var t=this.$hidden.val();return"function"==typeof this.options.syntax&&(t=t.replace(/@\[\[(\d+):user:([^\]]+)\]\]/g,d.proxy(function(t,e,s){return this.options.syntax({id:e,title:s})},this))),t},v.prototype.textarea_on_keydown=function(t){var e=t.keyCode;this.dropdown_is_visible&&0<=[s,i,n,r].indexOf(e)&&(t.preventDefault(),t.stopPropagation()),this.prev_sel_start=this.textarea.selectionStart,this.prev_sel_end=this.textarea.selectionEnd},v.prototype.textarea_on_keyup=function(t){var e=t.keyCode;this.dropdown_is_visible&&(e!==n&&e!==r||(this.dropdown_change_item(e),t.preventDefault(),t.stopPropagation()),e===s&&(this.dropdown_select_item(),t.preventDefault(),t.stopPropagation()),e===i&&(this.dropdown_hide(),t.preventDefault(),t.stopPropagation()))},v.prototype.textarea_on_input=function(t){var e,s,a,i,n,r,o,p,d,h,_,g=this.textarea.value;if(this.tags_added){if(this.prev_sel_start!==this.prev_sel_end)for(h=0;h<this.tags_added.length;h++)a=(s=this.tags_added[h]).start+s.length,(this.prev_sel_start>s.start&&this.prev_sel_start<a||this.prev_sel_end>s.start&&this.prev_sel_end<a||s.start>=this.prev_sel_start&&a<=this.prev_sel_end)&&this.tags_added.splice(h--,1);for(e=this.textarea.selectionStart-this.prev_sel_start-(this.prev_sel_end-this.prev_sel_start),h=0;h<this.tags_added.length;h++)if((s=this.tags_added[h]).start>=this.prev_sel_start)s.start+=e;else if((a=s.start+s.length)<this.prev_sel_start);else if(a>this.prev_sel_start){if(0<e)this.tags_added.splice(h--,1);else if(e<0){for(r=(i=g.substring(s.start,this.prev_sel_start+e)).split(" ").length-1,(i=s.name.split(" ")).splice(r,1),i=i.join(" "),n=(n=(n=s.name.split(" ")).slice(0,r)).join(" "),o=new RegExp("^([\\s\\S]{"+s.start+"})([\\s\\S]{"+(s.length+e)+"})"),p="$1"+i,this.textarea.value=this.textarea.value.replace(o,p),this.textarea.setSelectionRange(s.start+n.length,s.start+n.length),g=this.textarea.value,d=s.length-i.length,s.name=i,s.length=i.length,_=h+1;_<this.tags_added.length;_++)this.tags_added[_].start-=d;i.length||this.tags_added.splice(h--,1),h=this.tags_added.length}}else if(e<0){for((i=s.name.split(" ")).pop(),i=i.join(" "),o=new RegExp("^([\\s\\S]{"+s.start+"})([\\s\\S]{"+(s.length+e)+"})"),p="$1"+i,this.textarea.value=this.textarea.value.replace(o,p),this.textarea.setSelectionRange(s.start+i.length,s.start+i.length),g=this.textarea.value,d=s.length-i.length,s.name=i,s.length=i.length,_=h+1;_<this.tags_added.length;_++)this.tags_added[_].start-=d;i.length||this.tags_added.splice(h--,1),h=this.tags_added.length}}this.hidden_update(g,this.tags_added||[]),this.dropdown_toggle()},v.prototype.textarea_on_blur=function(t){},v.prototype.beautifier_update=function(t,e){var s,a,i,n,r;if(e.length){for(s="^",a="",r=i=0;r<e.length;r++)s+="([\\s\\S]{"+((n=e[r]).start-i)+"})([\\s\\S]{"+n.length+"})",a+="$"+(2*r+1)+"[[["+n.name+"]]]",i=n.start+n.length;s=new RegExp(s),t=t.replace(s,a)}return t=t.replace(/\[\[\[([^\[\]]+)\]\]\]/g,'<ps_span class="ps-tag">$1</ps_span>')},v.prototype.hidden_update=a.debounce(function(t,e){var s,a,i,n,r;if(e.length){for(s="^",a="",r=i=0;r<e.length;r++)s+="([\\s\\S]{"+((n=e[r]).start-i)+"})([\\s\\S]{"+n.length+"})",a+="$"+(2*r+1)+"@[["+n.id+":user:"+n.name+"]]",i=n.start+n.length;s=new RegExp(s),t=t.replace(s,a)}this.$hidden.val(t)},50),v.prototype.dropdown_toggle=a.debounce(function(){var t=this.textarea.selectionStart,e=this.textarea.value.substr(0,t),s=e.lastIndexOf("@");s<0||++s>=t?this.dropdown_hide():(e=e.substring(s,t),this.dropdown_fetch(e,d.proxy(this.dropdown_update,this)))},200),v.prototype.dropdown_fetch=function(s,a){"function"==typeof this.options.fetcher?this.dropdown_fetching||(this.dropdown_fetching=!0,this.$dropdown.find(f).show(),this.options.fetcher(s,d.proxy(function(t,e){this.$dropdown.find(f).hide(),this.dropdown_fetching=!1,"cache"===e?a(s,t):this.dropdown_toggle()},this))):a(s,[])},v.prototype.dropdown_filter=function(e,t){var s=[];return this.tags_added&&this.tags_added.length&&(s=a.map(this.tags_added,function(t){return""+t.id})),e=e.toLowerCase(),a.filter(t,function(t){return-1===s.indexOf(""+t.id)&&-1<t.name.toLowerCase().indexOf(e)})},v.prototype.dropdown_update=function(t,e){var s,a;if((e=this.dropdown_filter(t,e)).length){for(s="",a=0;a<e.length;a++)s+='<div class="'+u.substr(1)+'" data-id="'+e[a].id+'" data-name="'+e[a].name+'">',s+='<a href="javascript:"><div class="ps-avatar"><img src="'+e[a].avatar+'"></div><span>'+e[a].name+"</span></a>",s+="</div>";this.dropdown_show(s)}},v.prototype.dropdown_show=function(t){this.$dropdown.html(t).show(),this.dropdown_is_visible=!0},v.prototype.dropdown_show_more=function(){},v.prototype.dropdown_hide=function(){this.$dropdown.hide(),this.dropdown_is_visible=!1},v.prototype.dropdown_on_mouseenter=function(t){this.dropdown_change_item(t)},v.prototype.dropdown_on_mousedown=function(){this.dropdown_is_clicked=!0},v.prototype.dropdown_on_mouseup=function(t){this.dropdown_select_item(t),this.dropdown_is_clicked=!1,this.dropdown_hide()},v.prototype.dropdown_change_item=function(t){var e,s,a,i=c.substr(1);if("number"!=typeof t)return s=(e=this.dropdown_selected_item=d(t.target)).siblings(c),e.addClass(i),void s.removeClass(i);(e=this.$dropdown.children(c)).length?(a=e[t===n?"prev":"next"](),e.removeClass(i),a.length?(this.dropdown_selected_item=a).addClass(i):this.dropdown_selected_item=!1):(e=this.dropdown_selected_item=this.$dropdown.children()[t===n?"last":"first"]()).addClass(i)},v.prototype.dropdown_select_item=function(t){var e,s,a=t?d(t.currentTarget):this.dropdown_selected_item,i=a.data("id"),n=a.data("name"),r=this.textarea.selectionStart,o=this.textarea.value.substr(0,r).lastIndexOf("@");this.tags_added||(this.tags_added=[]),this.tags_added.push({id:i,name:n,start:o,length:n.length}),e=new RegExp("^([\\s\\S]{"+o+"})[\\s\\S]{"+(r-o)+"}"),s=this.textarea.value.replace(e,"$1"+n)+" ",this.textarea.value=s,this.textarea.setSelectionRange(o+n.length+1,o+n.length+1);var p=this;setTimeout(function(){p.$textarea.trigger("keyup"),p.$textarea.trigger("input")}),this.hidden_update(s,this.tags_added),this.dropdown_hide(),this.$textarea.focus()},v}(i,a),i.fn.ps_tagging=function(s,a){return"object"===(void 0===s?"undefined":o(s))&&(a=s),this.each(function(){var t=i(this),e=t.data("ps_tagging");e||(e=new r(this,a),t.data("ps_tagging",e)),"val"===s&&"function"==typeof a?a(e.val()):"reset"===s&&e.reset()})},n.observer.addFilter("peepso_postbox_beautifier",function(t,e){var s=e.data("ps_tagging"),a=e.val(),i=s.tags_added||[];return s.beautifier_update(a,i)},10,2)},{}]},{},[1]);